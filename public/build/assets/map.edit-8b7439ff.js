import{E as R,b,I as u,g as S,c as w,i as M,d as U,P as H,C as k,e as T,s as F,R as z,f as X,h as G,j as P,G as V,a as Y,k as _,S as W,l as q,m as $,M as B,V as O}from"./ModelXmlSerializer-35f2b72c.js";class j extends R{constructor(e=100){super(),this.size=100,this.history=[],this.indexOfNextAdd=0,this.size=e,this.clear()}isEmpty(){return this.history.length==0}clear(){this.history=[],this.indexOfNextAdd=0,this.fireEvent(new b(u.CLEAR))}canUndo(){return this.indexOfNextAdd>0}undo(){for(;this.indexOfNextAdd>0;){const e=this.history[--this.indexOfNextAdd];if(e.undo(),e.isSignificant()){this.fireEvent(new b(u.UNDO,{edit:e}));break}}}canRedo(){return this.indexOfNextAdd<this.history.length}redo(){const e=this.history.length;for(;this.indexOfNextAdd<e;){const n=this.history[this.indexOfNextAdd++];if(n.redo(),n.isSignificant()){this.fireEvent(new b(u.REDO,{edit:n}));break}}}undoableEditHappened(e){this.trim(),this.size>0&&this.size==this.history.length&&this.history.shift(),this.history.push(e),this.indexOfNextAdd=this.history.length,this.fireEvent(new b(u.ADD,{edit:e}))}trim(){if(this.history.length>this.indexOfNextAdd){const e=this.history.splice(this.indexOfNextAdd,this.history.length-this.indexOfNextAdd);for(let n=0;n<e.length;n+=1)e[n].die()}}}const K=j;class A{constructor(e){this.first=null,this.destroyed=!1,this.dragHandler=null,this.dropHandler=null,this.x=0,this.y=0,this.width=0,this.height=0,this.defaultOpacity=20,this.enabled=!0,this.div=null,this.sharedDiv=null,this.currentX=0,this.currentY=0,this.fadeOut=!1,this.graph=e,this.graph.addMouseListener(this),this.forceRubberbandHandler=(n,r)=>{const i=r.getProperty("eventName"),o=r.getProperty("event");if(i===u.MOUSE_DOWN&&this.isForceRubberbandEvent(o)){const a=S(this.graph.container),d=w(this.graph.container);d.x-=a.x,d.y-=a.y,this.start(o.getX()+d.x,o.getY()+d.y),o.consume(!1)}},this.graph.addListener(u.FIRE_MOUSE_EVENT,this.forceRubberbandHandler),this.panHandler=()=>{this.repaint()},this.graph.addListener(u.PAN,this.panHandler),this.gestureHandler=(n,r)=>{this.first&&this.reset()},this.graph.addListener(u.GESTURE,this.gestureHandler)}isEnabled(){return this.enabled}setEnabled(e){this.enabled=e}isForceRubberbandEvent(e){return M(e.getEvent())}mouseDown(e,n){if(!n.isConsumed()&&this.isEnabled()&&this.graph.isEnabled()&&!n.getState()&&!U(n.getEvent())){const r=S(this.graph.container),i=w(this.graph.container);i.x-=r.x,i.y-=r.y,this.start(n.getX()+i.x,n.getY()+i.y),n.consume(!1)}}start(e,n){this.first=new H(e,n);const{container:r}=this.graph;function i(o){const a=new G(o),d=P(r,a.getX(),a.getY());return a.graphX=d.x,a.graphY=d.y,a}this.dragHandler=o=>{this.mouseMove(this.graph,i(o))},this.dropHandler=o=>{this.mouseUp(this.graph,i(o))},k.IS_FF&&u.addGestureListeners(document,null,this.dragHandler,this.dropHandler)}mouseMove(e,n){if(!n.isConsumed()&&this.first){const r=w(this.graph.container),i=S(this.graph.container);r.x-=i.x,r.y-=i.y;const o=n.getX()+r.x,a=n.getY()+r.y,d=this.first.x-o,l=this.first.y-a,c=this.graph.getEventTolerance();(this.div||Math.abs(d)>c||Math.abs(l)>c)&&(this.div||(this.div=this.createShape()),T(),this.update(o,a),n.consume())}}createShape(){this.sharedDiv||(this.sharedDiv=document.createElement("div"),this.sharedDiv.className="mxRubberband",F(this.sharedDiv,this.defaultOpacity)),this.graph.container.appendChild(this.sharedDiv);const e=this.sharedDiv;return k.IS_SVG&&this.fadeOut&&(this.sharedDiv=null),e}isActive(e,n){return this.div&&this.div.style.display!=="none"}mouseUp(e,n){const r=this.isActive();this.reset(),r&&(this.execute(n.getEvent()),n.consume())}execute(e){const n=new z(this.x,this.y,this.width,this.height);this.graph.selectRegion(n,e)}reset(){if(this.div)if(k.IS_SVG&&this.fadeOut){const e=this.div;X(e.style,"transition","all 0.2s linear"),e.style.pointerEvents="none",e.style.opacity=String(0),window.setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},200)}else this.div.parentNode&&this.div.parentNode.removeChild(this.div);u.removeGestureListeners(document,null,this.dragHandler,this.dropHandler),this.dragHandler=null,this.dropHandler=null,this.currentX=0,this.currentY=0,this.first=null,this.div=null}update(e,n){this.currentX=e,this.currentY=n,this.repaint()}repaint(){if(this.div&&this.first){const e=this.currentX-this.graph.getPanDx(),n=this.currentY-this.graph.getPanDy();this.x=Math.min(this.first.x,e),this.y=Math.min(this.first.y,n),this.width=Math.max(this.first.x,e)-this.x,this.height=Math.max(this.first.y,n)-this.y;const r=0,i=0;this.div.style.left=`${this.x+r}px`,this.div.style.top=`${this.y+i}px`,this.div.style.width=`${Math.max(1,this.width)}px`,this.div.style.height=`${Math.max(1,this.height)}px`}}onDestroy(){this.destroyed||(this.destroyed=!0,this.graph.removeMouseListener(this),this.graph.removeListener(this.forceRubberbandHandler),this.graph.removeListener(this.panHandler),this.reset(),this.sharedDiv&&(this.sharedDiv=null))}}A.pluginId="RubberBandHandler";const J=A,Q=[_,W,q,$,J],h=document.getElementById("graph-container");document.createElement("div");const s=new V(h,new Y,Q),m=s.getDataModel();var E=s.getStylesheet().getDefaultEdgeStyle();E.labelBackgroundColor="#FFFFFF";E.strokeWidth=2;E.rounded=!0;E.entryPerimeter=!1;E.edgeStyle="manhattanEdgeStyle";O.selectionColor="#00a8ff";O.selectionStrokeWidth=2;const f=new K;function Z(t,e){const n=(r,i)=>{const o=i.getProperty("edit");e.undoableEditHappened(o)};m.addListener(u.UNDO,n),t.getView().addListener(u.UNDO,n)}Z(s,f);const ee=document.getElementById("undoButton"),te=document.getElementById("redoButton");ee.addEventListener("click",()=>{f.canUndo()&&f.undo()});te.addEventListener("click",()=>{f.canRedo()&&f.redo()});document.addEventListener("keydown",t=>{t.ctrlKey&&t.key==="z"?(t.preventDefault(),f.canUndo()&&f.undo()):(t.ctrlKey&&t.key==="y"||t.ctrlKey&&t.shiftKey&&t.key==="z")&&(t.preventDefault(),f.canRedo()&&f.redo())});const g=document.getElementById("context-menu"),v=document.getElementById("edge-color-select"),x=document.getElementById("edge-thickness-select"),ne=document.getElementById("apply-edge-style");let p=null;s.container.addEventListener("contextmenu",t=>{t.preventDefault();const e=s.getCellAt(t.offsetX,t.offsetY);if(e!=null)if(e.isEdge()){p=e;const n=h.getBoundingClientRect(),r=t.clientX-n.left,i=t.clientY-n.top;g.style.display="block",g.style.left=`${r+75}px`,g.style.top=`${i+100}px`;const o=s.getCellStyle(e);v.value=o.strokeColor||"#000000",x.value=o.strokeWidth||"1"}else if(e.isVertex()){if(e.style.image==null){p=e;const n=h.getBoundingClientRect(),r=t.clientX-n.left,i=t.clientY-n.top;g.style.display="block",g.style.left=`${r+75}px`,g.style.top=`${i+100}px`;const o=s.getCellStyle(e);v.value=o.strokeColor||"#000000",x.value=o.strokeWidth||"1"}}else g.style.display="none"});ne.addEventListener("click",()=>{console.log("change style"),event.preventDefault(),p&&(console.log(p),console.log("update edge "+v.value+" "+x.value),s.batchUpdate(()=>{const t=s.getCellStyle(p);console.log(t),p.isEdge()?s.setCellStyle({...t,strokeColor:v.value,strokeWidth:parseInt(x.value,10)},[p]):s.setCellStyle({...t,fillColor:v.value,strokeWidth:parseInt(x.value,10)},[p])})),g.style.display="none"});document.addEventListener("click",t=>{g.contains(t.target)||(g.style.display="none")});s.setGridEnabled(!0);s.setGridSize(10);h.style.backgroundImage=`
  linear-gradient(to right, #e0e0e0 1px, transparent 1px),
  linear-gradient(to bottom, #e0e0e0 1px, transparent 1px)
`;h.style.backgroundSize="10px 10px";s.setPanning(!0);function se(t){new B(m).import(t)}window.loadGraph=se;async function ie(t,e,n,r){try{const i=await fetch("/admin/graph/save",{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({id:t,name:e,type:n,content:r})});if(!i.ok){const a=await i.json();throw new Error(a.message||"Erreur lors de la sauvegarde du graphe.")}const o=await i.json();console.log("Graphe sauvegardé avec succès :",o.graph)}catch(i){console.error("Erreur lors de la sauvegarde :",i),alert("Erreur lors de la sauvegarde du graphe.")}}function re(){return new B(m).export()}window.getXMLGraph=re;function oe(){const t=new B(m).export();ie(document.querySelector("#id").value,document.querySelector("#name").value,document.querySelector("#type").value,t)}const ae=document.getElementById("saveButton");ae.addEventListener("click",oe);const le=document.getElementById("font-btn");le.addEventListener("dragstart",t=>{t.dataTransfer.setData("node-type","text-node")});h.addEventListener("dragover",t=>{t.preventDefault()});h.addEventListener("drop",t=>{if(t.preventDefault(),t.dataTransfer.getData("node-type")=="text-node"){const e=h.getBoundingClientRect(),n=t.clientX-e.left,r=t.clientY-e.top;s.batchUpdate(()=>{const i=s.getDefaultParent();s.insertVertex({parent:i,value:"Text",position:[n,r],size:[150,30],style:{fillColor:"none",strokeColor:"none",fontColor:"#000000",fontSize:14,align:"left",verticalAlign:"middle"}}).setAttribute("editable","true")})}});const de=document.getElementById("square-btn");de.addEventListener("dragstart",t=>{t.dataTransfer.setData("node-type","square-node")});h.addEventListener("dragover",t=>{t.preventDefault()});h.addEventListener("drop",t=>{if(t.preventDefault(),t.dataTransfer.getData("node-type")=="square-node"){const e=h.getBoundingClientRect(),n=t.clientX-e.left,r=t.clientY-e.top;s.batchUpdate(()=>{const i=s.getDefaultParent(),o=s.insertVertex({parent:i,value:"",position:[n,r],size:[150,120],style:{fillColor:"#fffacd",strokeColor:"#000000",strokeWidth:1,rounded:2}});s.orderCells(!0,[o])})}});const D=document.getElementById("nodeImage"),L=document.getElementById("node");D.addEventListener("dragstart",t=>{t.dataTransfer.setData("node-type","icon-node")});h.addEventListener("dragover",t=>{t.preventDefault()});h.addEventListener("drop",t=>{if(t.preventDefault(),t.dataTransfer.getData("node-type")=="icon-node"&&D.src!=""){const e=h.getBoundingClientRect(),n=t.clientX-e.left,r=t.clientY-e.top;s.batchUpdate(()=>{const i=s.getDefaultParent(),o=m.getCell(L.value);if(o!=null)s.setSelectionCells(o);else{const a=_nodes.get(L.value),d=s.insertVertex({parent:i,id:L.value,value:a.label,position:[n-16,r-16],size:[32,32],style:{shape:"image",image:D.src,editable:!1,resizable:!1,verticalLabelPosition:"bottom",spacingTop:-15}});a.edges.forEach(function(l){const c=m.getCell(l.attachedNodeId);c!=null&&s.insertEdge({parent:i,value:"",source:d,target:c,style:{editable:!1,stroke:"#FF",strokeWidth:1,startArrow:"none",endArrow:"none"}})})}})}});const ce=document.getElementById("zoom-in-btn"),he=document.getElementById("zoom-out-btn");ce.addEventListener("click",()=>{s.zoom(1.2)});he.addEventListener("click",()=>{s.zoom(.8)});document.addEventListener("keydown",t=>{if(t.key==="Delete"){const e=s.getSelectionCells();e.length>0&&s.removeCells(e)}});s.setConnectable(!1);s.isCellDisconnectable=function(){return!1};const ue=document.getElementById("group-btn"),ge=document.getElementById("ungroup-btn");ue.addEventListener("click",()=>{const t=s.getSelectionCells();if(t.length>0){const e=s.createVertex(null,null,"",0,0,100,100,"mxGroup");s.addCell(e),s.groupCells(e,0,t)}});ge.addEventListener("click",()=>{const t=s.getSelectionCells();t.length>0&&(s.ungroupCells(t),s.setSelectionCells(t))});function C(t,e,n){const r=t.getSelectionCell();r&&r.isVertex()&&t.batchUpdate(()=>{const i=r.getGeometry();i&&(i.translate(e,n),t.refresh())})}document.addEventListener("keydown",t=>{switch(t.key){case"ArrowUp":C(s,0,-1);break;case"ArrowDown":C(s,0,1);break;case"ArrowLeft":C(s,-1,0);break;case"ArrowRight":C(s,1,0);break}});function fe(t,e,n){const r=[],i=2*Math.PI/n;for(let o=0;o<n;o++){const a=o*i,d=t.x+e*Math.cos(a),l=t.y+e*Math.sin(a);r.push({x:d,y:l})}return r}function pe(){let t=[];for(let e of document.getElementById("filters").options)e.selected&&t.push(e.value);return t}function ye(t,e,n){let r=!1;return s.getEdges(t).forEach(o=>{if(o.target==e&&(n==null||o.value==n)){r=!0;return}}),r||s.getEdges(e).forEach(a=>{if(a.target==t&&(n==null||a.value==n)){r=!0;return}}),r}s.addListener(u.DOUBLE_CLICK,(t,e)=>{const n=e.getProperty("cell");if(n&&n.isVertex()&&n.style.shape=="image"){const r=_nodes.get(n.id);if(r==null)return;s.batchUpdate(()=>{let i=[];const o=s.getDefaultParent(),a=pe();r.edges.forEach(function(l){let c=_nodes.get(l.attachedNodeId);if(c!=null){const y=m.getCell(l.attachedNodeId);y==null?(a.length==0||a.includes(c.vue)||a.includes("8")&&l.edgeType==="CABLE"||a.includes("9")&&l.edgeType==="FLUX")&&i.push(l):ye(n,y,l.name)||s.insertEdge({parent:o,value:l.name,source:n,target:y,style:{editable:!1,stroke:"#FF",strokeWidth:1,startArrow:l.edgeType=="FLUX"&&(l.bidirectional||l.edgeDirection=="FROM")?"classic":"none",endArrow:l.edgeType=="FLUX"&&(l.bidirectional||l.edgeDirection=="TO")?"classic":"none"}})}}),h.getBoundingClientRect();const d=fe({x:n.getGeometry().x,y:n.getGeometry().y},80,i.length);for(let l=0;l<d.length;l++){const c=i[l],y=_nodes.get(c.attachedNodeId),N=s.insertVertex({parent:o,id:y.id,value:y.label,position:[d[l].x,d[l].y],size:[32,32],style:{shape:"image",image:y.image,editable:!1,resizable:!1,verticalLabelPosition:"bottom",spacingTop:-15}});s.insertEdge({parent:o,value:i[l].name,source:n,target:N,style:{editable:!1,stroke:"#FF",strokeWidth:1,startArrow:c.edgeType=="FLUX"&&(c.bidirectional||c.edgeDirection=="FROM")?"classic":"none",endArrow:c.edgeType=="FLUX"&&(c.bidirectional||c.edgeDirection=="TO")?"classic":"none"}})}})}});const me=document.getElementById("update-btn");me.addEventListener("click",()=>{s.batchUpdate(()=>{s.getChildCells().forEach(e=>{if(!e.isEdge()){if(e.style.image!=null){const n=_nodes.get(e.id);n==null?s.removeCells([e],!0):(e.value=n.label,e.style.image=n.image)}}}),s.refresh()})});const I=s.container.querySelector("svg");function ve(t){t.querySelectorAll("image").forEach(n=>{const r=n.getAttribute("xlink:href");fetch(r).then(i=>i.blob()).then(i=>{const o=new FileReader;o.onloadend=()=>{n.setAttribute("xlink:href",o.result)},o.readAsDataURL(i)})})}function xe(){ve(I),setTimeout(()=>{const e=new XMLSerializer().serializeToString(I),n=new Blob([e],{type:"image/svg+xml;charset=utf-8"}),r=URL.createObjectURL(n),i=document.createElement("a");i.href=r,i.download="graph_with_images.svg",i.click(),URL.revokeObjectURL(r)},1e3)}const Ee=document.getElementById("download-btn");Ee.addEventListener("click",xe);
