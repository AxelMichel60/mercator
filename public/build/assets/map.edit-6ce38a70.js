import{E as H,b as E,I as h,g as S,c as D,i as T,d as F,P as z,C as L,e as P,s as X,R as G,f as V,h as Y,j as k,G as _,a as W,k as O,l as A,m as q,S as j,n as K,o as J,M as N,V as U}from"./ModelXmlSerializer-0e8aa138.js";class Q extends H{constructor(e=100){super(),this.size=100,this.history=[],this.indexOfNextAdd=0,this.size=e,this.clear()}isEmpty(){return this.history.length==0}clear(){this.history=[],this.indexOfNextAdd=0,this.fireEvent(new E(h.CLEAR))}canUndo(){return this.indexOfNextAdd>0}undo(){for(;this.indexOfNextAdd>0;){const e=this.history[--this.indexOfNextAdd];if(e.undo(),e.isSignificant()){this.fireEvent(new E(h.UNDO,{edit:e}));break}}}canRedo(){return this.indexOfNextAdd<this.history.length}redo(){const e=this.history.length;for(;this.indexOfNextAdd<e;){const n=this.history[this.indexOfNextAdd++];if(n.redo(),n.isSignificant()){this.fireEvent(new E(h.REDO,{edit:n}));break}}}undoableEditHappened(e){this.trim(),this.size>0&&this.size==this.history.length&&this.history.shift(),this.history.push(e),this.indexOfNextAdd=this.history.length,this.fireEvent(new E(h.ADD,{edit:e}))}trim(){if(this.history.length>this.indexOfNextAdd){const e=this.history.splice(this.indexOfNextAdd,this.history.length-this.indexOfNextAdd);for(let n=0;n<e.length;n+=1)e[n].die()}}}const Z=Q;class R{constructor(e){this.first=null,this.destroyed=!1,this.dragHandler=null,this.dropHandler=null,this.x=0,this.y=0,this.width=0,this.height=0,this.defaultOpacity=20,this.enabled=!0,this.div=null,this.sharedDiv=null,this.currentX=0,this.currentY=0,this.fadeOut=!1,this.graph=e,this.graph.addMouseListener(this),this.forceRubberbandHandler=(n,i)=>{const r=i.getProperty("eventName"),o=i.getProperty("event");if(r===h.MOUSE_DOWN&&this.isForceRubberbandEvent(o)){const a=S(this.graph.container),d=D(this.graph.container);d.x-=a.x,d.y-=a.y,this.start(o.getX()+d.x,o.getY()+d.y),o.consume(!1)}},this.graph.addListener(h.FIRE_MOUSE_EVENT,this.forceRubberbandHandler),this.panHandler=()=>{this.repaint()},this.graph.addListener(h.PAN,this.panHandler),this.gestureHandler=(n,i)=>{this.first&&this.reset()},this.graph.addListener(h.GESTURE,this.gestureHandler)}isEnabled(){return this.enabled}setEnabled(e){this.enabled=e}isForceRubberbandEvent(e){return T(e.getEvent())}mouseDown(e,n){if(!n.isConsumed()&&this.isEnabled()&&this.graph.isEnabled()&&!n.getState()&&!F(n.getEvent())){const i=S(this.graph.container),r=D(this.graph.container);r.x-=i.x,r.y-=i.y,this.start(n.getX()+r.x,n.getY()+r.y),n.consume(!1)}}start(e,n){this.first=new z(e,n);const{container:i}=this.graph;function r(o){const a=new Y(o),d=k(i,a.getX(),a.getY());return a.graphX=d.x,a.graphY=d.y,a}this.dragHandler=o=>{this.mouseMove(this.graph,r(o))},this.dropHandler=o=>{this.mouseUp(this.graph,r(o))},L.IS_FF&&h.addGestureListeners(document,null,this.dragHandler,this.dropHandler)}mouseMove(e,n){if(!n.isConsumed()&&this.first){const i=D(this.graph.container),r=S(this.graph.container);i.x-=r.x,i.y-=r.y;const o=n.getX()+i.x,a=n.getY()+i.y,d=this.first.x-o,l=this.first.y-a,c=this.graph.getEventTolerance();(this.div||Math.abs(d)>c||Math.abs(l)>c)&&(this.div||(this.div=this.createShape()),P(),this.update(o,a),n.consume())}}createShape(){this.sharedDiv||(this.sharedDiv=document.createElement("div"),this.sharedDiv.className="mxRubberband",X(this.sharedDiv,this.defaultOpacity)),this.graph.container.appendChild(this.sharedDiv);const e=this.sharedDiv;return L.IS_SVG&&this.fadeOut&&(this.sharedDiv=null),e}isActive(e,n){return this.div&&this.div.style.display!=="none"}mouseUp(e,n){const i=this.isActive();this.reset(),i&&(this.execute(n.getEvent()),n.consume())}execute(e){const n=new G(this.x,this.y,this.width,this.height);this.graph.selectRegion(n,e)}reset(){if(this.div)if(L.IS_SVG&&this.fadeOut){const e=this.div;V(e.style,"transition","all 0.2s linear"),e.style.pointerEvents="none",e.style.opacity=String(0),window.setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},200)}else this.div.parentNode&&this.div.parentNode.removeChild(this.div);h.removeGestureListeners(document,null,this.dragHandler,this.dropHandler),this.dragHandler=null,this.dropHandler=null,this.currentX=0,this.currentY=0,this.first=null,this.div=null}update(e,n){this.currentX=e,this.currentY=n,this.repaint()}repaint(){if(this.div&&this.first){const e=this.currentX-this.graph.getPanDx(),n=this.currentY-this.graph.getPanDy();this.x=Math.min(this.first.x,e),this.y=Math.min(this.first.y,n),this.width=Math.max(this.first.x,e)-this.x,this.height=Math.max(this.first.y,n)-this.y;const i=0,r=0;this.div.style.left=`${this.x+i}px`,this.div.style.top=`${this.y+r}px`,this.div.style.width=`${Math.max(1,this.width)}px`,this.div.style.height=`${Math.max(1,this.height)}px`}}onDestroy(){this.destroyed||(this.destroyed=!0,this.graph.removeMouseListener(this),this.graph.removeListener(this.forceRubberbandHandler),this.graph.removeListener(this.panHandler),this.reset(),this.sharedDiv&&(this.sharedDiv=null))}}R.pluginId="RubberBandHandler";const ee=R,te=[q,j,K,J,ee],u=document.getElementById("graph-container");document.createElement("div");const s=new _(u,new W,te),m=s.getDataModel();var v=s.getStylesheet().getDefaultEdgeStyle();v.labelBackgroundColor="#FFFFFF";v.strokeWidth=2;v.rounded=!0;v.entryPerimeter=!1;v.edgeStyle="manhattanEdgeStyle";s.options.expandedImage=null;U.selectionColor="#00a8ff";U.selectionStrokeWidth=2;const y=new Z;function ne(t,e){const n=(i,r)=>{const o=r.getProperty("edit");e.undoableEditHappened(o)};m.addListener(h.UNDO,n),t.getView().addListener(h.UNDO,n)}ne(s,y);const se=document.getElementById("undoButton"),ie=document.getElementById("redoButton");se.addEventListener("click",()=>{y.canUndo()&&y.undo()});ie.addEventListener("click",()=>{y.canRedo()&&y.redo()});document.addEventListener("keydown",t=>{t.ctrlKey&&t.key==="z"?(t.preventDefault(),y.canUndo()&&y.undo()):t.ctrlKey&&t.key==="y"&&(t.preventDefault(),y.canRedo()&&y.redo())});const f=document.getElementById("context-menu"),w=document.getElementById("edge-color-select"),C=document.getElementById("edge-thickness-select"),re=document.getElementById("apply-edge-style");let g=null;s.container.addEventListener("contextmenu",t=>{t.preventDefault();const e=s.getCellAt(t.offsetX,t.offsetY);if(e!=null)if(e.isEdge()){g=e;const n=u.getBoundingClientRect(),i=t.clientX-n.left,r=t.clientY-n.top;f.style.display="block",f.style.left=`${i+75}px`,f.style.top=`${r+100}px`;const o=s.getCellStyle(e);w.value=o.strokeColor||"#000000",C.value=o.strokeWidth||"1"}else if(e.isVertex()){if(e.style.image==null){g=e;const n=u.getBoundingClientRect(),i=t.clientX-n.left,r=t.clientY-n.top;f.style.display="block",f.style.left=`${i+75}px`,f.style.top=`${r+100}px`;const o=s.getCellStyle(e);w.value=o.strokeColor||"#000000",C.value=o.strokeWidth||"1"}}else f.style.display="none"});re.addEventListener("click",()=>{event.preventDefault(),g&&s.batchUpdate(()=>{s.getCellStyle(g),g.isEdge()?(g.style.strokeColor=w.value,g.style.strokeWidth=parseInt(C.value,10)):(g.style.fillColor=w.value,g.style.strokeWidth=parseInt(C.value,10)),s.refresh(g)}),f.style.display="none"});document.addEventListener("click",t=>{f.contains(t.target)||(f.style.display="none")});s.setGridEnabled(!0);s.setGridSize(10);u.style.backgroundImage=`
  linear-gradient(to right, #e0e0e0 1px, transparent 1px),
  linear-gradient(to bottom, #e0e0e0 1px, transparent 1px)
`;u.style.backgroundSize="10px 10px";s.setPanning(!0);function oe(t){new N(m).import(t)}window.loadGraph=oe;async function ae(t,e,n,i){try{const r=await fetch("/admin/graph/save",{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({id:t,name:e,type:n,content:i})});if(r.status!=200){const o=await r.json();throw new Error(o.message||"Erreur lors de la sauvegarde du graphe.")}}catch(r){console.error("Erreur lors de la sauvegarde :",r),alert("Erreur lors de la sauvegarde du graphe.")}}function le(){return new N(m).export()}window.getXMLGraph=le;function de(){const t=new N(m).export();ae(document.querySelector("#id").value,document.querySelector("#name").value,document.querySelector("#type").value,t)}const ce=document.getElementById("saveButton");ce.addEventListener("click",de);const he=document.getElementById("font-btn");he.addEventListener("dragstart",t=>{t.dataTransfer.setData("node-type","text-node")});u.addEventListener("dragover",t=>{t.preventDefault()});u.addEventListener("drop",t=>{if(t.preventDefault(),t.dataTransfer.getData("node-type")=="text-node"){const e=k(s.container,A(t),O(t)),n=s.view.translate,{scale:i}=s.view,r=e.x/i-n.x,o=e.y/i-n.y;s.batchUpdate(()=>{const a=s.getDefaultParent();s.insertVertex({parent:a,value:"Text",position:[r,o],size:[150,30],style:{fillColor:"none",strokeColor:"none",fontColor:"#000000",fontSize:14,align:"left",verticalAlign:"middle"}}).setAttribute("editable","true")})}});const ue=document.getElementById("square-btn");ue.addEventListener("dragstart",t=>{t.dataTransfer.setData("node-type","square-node")});u.addEventListener("dragover",t=>{t.preventDefault()});u.addEventListener("drop",t=>{if(t.preventDefault(),t.dataTransfer.getData("node-type")=="square-node"){const e=k(s.container,A(t),O(t)),n=s.view.translate,{scale:i}=s.view,r=e.x/i-n.x,o=e.y/i-n.y;s.batchUpdate(()=>{const a=s.getDefaultParent(),d=s.insertVertex({parent:a,value:"",position:[r,o],size:[150,120],style:{fillColor:"#fffacd",strokeColor:"#000000",strokeWidth:1,rounded:2}});s.orderCells(!0,[d])})}});const B=document.getElementById("nodeImage"),I=document.getElementById("node");B.addEventListener("dragstart",t=>{t.dataTransfer.setData("node-type","icon-node")});u.addEventListener("dragover",t=>{t.preventDefault()});u.addEventListener("drop",t=>{if(t.preventDefault(),t.dataTransfer.getData("node-type")=="icon-node"&&B.src!=""){const e=k(s.container,A(t),O(t)),n=s.view.translate,{scale:i}=s.view,r=e.x/i-n.x,o=e.y/i-n.y;s.batchUpdate(()=>{const a=s.getDefaultParent(),d=m.getCell(I.value);if(d!=null)s.setSelectionCells(d);else{const l=_nodes.get(I.value),c=s.insertVertex({parent:a,id:I.value,value:l.label,position:[r-16,o-16],size:[32,32],style:{shape:"image",image:B.src,editable:!1,resizable:!1,verticalLabelPosition:"bottom",spacingTop:-15}});l.edges.forEach(function(p){const x=m.getCell(p.attachedNodeId);x!=null&&s.insertEdge({parent:a,value:"",source:c,target:x,style:{editable:!1,stroke:"#FF",strokeWidth:1,startArrow:"none",endArrow:"none"}})})}})}});const ge=document.getElementById("zoom-in-btn"),fe=document.getElementById("zoom-out-btn");ge.addEventListener("click",()=>{s.zoomIn()});fe.addEventListener("click",()=>{s.zoomOut()});document.addEventListener("keydown",t=>{if(t.key==="Delete"||t.key==="Backspace"){const e=s.getSelectionCells();e.length>0&&s.removeCells(e)}});$("body").keydown(function(t){t.ctrlKey&&t.keyCode==65&&(t.preventDefault(),t.stopPropagation(),s.selectAll())});s.setConnectable(!1);s.isCellDisconnectable=function(){return!1};const pe=document.getElementById("group-btn"),ye=document.getElementById("ungroup-btn");pe.addEventListener("click",()=>{const t=s.getSelectionCells();if(t.length>1){const e=s.getDefaultParent(),n=s.insertVertex({parent:e,style:{fillColor:"none",strokeColor:"none"}});s.addCell(n),s.groupCells(n,5,t)}});ye.addEventListener("click",()=>{const t=s.getSelectionCells();t.length==1&&(s.ungroupCells(t),s.setSelectionCells(t))});function b(t,e,n){const i=t.getSelectionCell();i&&i.isVertex()&&t.batchUpdate(()=>{const r=i.getGeometry();r&&(r.translate(e,n),t.refresh())})}document.addEventListener("keydown",t=>{switch(t.key){case"ArrowUp":b(s,0,-1);break;case"ArrowDown":b(s,0,1);break;case"ArrowLeft":b(s,-1,0);break;case"ArrowRight":b(s,1,0);break}});function me(t,e,n){const i=[],r=2*Math.PI/n;for(let o=0;o<n;o++){const a=o*r,d=t.x+e*Math.cos(a),l=t.y+e*Math.sin(a);i.push({x:d,y:l})}return i}function ve(){let t=[];for(let e of document.getElementById("filters").options)e.selected&&t.push(e.value);return t}function xe(t,e,n){let i=!1;return s.getEdges(t).forEach(o=>{if(o.target==e&&(n==null||o.value==n)){i=!0;return}}),i||s.getEdges(e).forEach(a=>{if(a.target==t&&(n==null||a.value==n)){i=!0;return}}),i}s.addListener(h.DOUBLE_CLICK,(t,e)=>{const n=e.getProperty("cell");if(n&&n.isVertex()&&n.style.shape=="image"){const i=_nodes.get(n.id);if(i==null)return;s.batchUpdate(()=>{let r=[];const o=s.getDefaultParent(),a=ve();i.edges.forEach(function(l){let c=_nodes.get(l.attachedNodeId);if(c!=null){const p=m.getCell(l.attachedNodeId);p==null?(a.length==0||a.includes(c.vue)||a.includes("8")&&l.edgeType==="CABLE"||a.includes("9")&&l.edgeType==="FLUX")&&r.push(l):xe(n,p,l.name)||s.insertEdge({parent:o,value:l.name,source:n,target:p,style:{editable:!1,stroke:"#FF",strokeWidth:1,startArrow:l.edgeType=="FLUX"&&(l.bidirectional||l.edgeDirection=="FROM")?"classic":"none",endArrow:l.edgeType=="FLUX"&&(l.bidirectional||l.edgeDirection=="TO")?"classic":"none"}})}}),u.getBoundingClientRect();const d=me({x:n.getGeometry().x,y:n.getGeometry().y},80,r.length);for(let l=0;l<d.length;l++){const c=r[l],p=_nodes.get(c.attachedNodeId),x=s.insertVertex({parent:o,id:p.id,value:p.label,position:[d[l].x,d[l].y],size:[32,32],style:{shape:"image",image:p.image,editable:!1,resizable:!1,verticalLabelPosition:"bottom",spacingTop:-15}});s.insertEdge({parent:o,value:r[l].name,source:n,target:x,style:{editable:!1,stroke:"#FF",strokeWidth:1,startArrow:c.edgeType=="FLUX"&&(c.bidirectional||c.edgeDirection=="FROM")?"classic":"none",endArrow:c.edgeType=="FLUX"&&(c.bidirectional||c.edgeDirection=="TO")?"classic":"none"}})}})}});const Ee=document.getElementById("update-btn");Ee.addEventListener("click",()=>{s.batchUpdate(()=>{s.getChildCells().forEach(e=>{if(!e.isEdge()){if(e.style.image!=null){const n=_nodes.get(e.id);n==null?s.removeCells([e],!0):(e.value=n.label,e.style.image=n.image)}}}),s.refresh()})});const M=s.container.querySelector("svg");function be(t){t.querySelectorAll("image").forEach(n=>{const i=n.getAttribute("xlink:href");fetch(i).then(r=>r.blob()).then(r=>{const o=new FileReader;o.onloadend=()=>{n.setAttribute("xlink:href",o.result)},o.readAsDataURL(r)})})}function we(){be(M),setTimeout(()=>{const e=new XMLSerializer().serializeToString(M),n=new Blob([e],{type:"image/svg+xml;charset=utf-8"}),i=URL.createObjectURL(n),r=document.createElement("a");r.href=i,r.download="graph_with_images.svg",r.click(),URL.revokeObjectURL(i)},1e3)}const Ce=document.getElementById("download-btn");Ce.addEventListener("click",we);
