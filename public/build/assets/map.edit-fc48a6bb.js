import{E as V,b,I as u,g as k,c as D,i as Y,d as _,P as q,C as I,e as W,s as j,R as K,f as J,h as Q,j as w,G as Z,a as ee,k as N,l as R,m as te,S as ne,n as se,o as ie,M as F,V as H}from"./ModelXmlSerializer-0e8aa138.js";class oe extends V{constructor(t=100){super(),this.size=100,this.history=[],this.indexOfNextAdd=0,this.size=t,this.clear()}isEmpty(){return this.history.length==0}clear(){this.history=[],this.indexOfNextAdd=0,this.fireEvent(new b(u.CLEAR))}canUndo(){return this.indexOfNextAdd>0}undo(){for(;this.indexOfNextAdd>0;){const t=this.history[--this.indexOfNextAdd];if(t.undo(),t.isSignificant()){this.fireEvent(new b(u.UNDO,{edit:t}));break}}}canRedo(){return this.indexOfNextAdd<this.history.length}redo(){const t=this.history.length;for(;this.indexOfNextAdd<t;){const n=this.history[this.indexOfNextAdd++];if(n.redo(),n.isSignificant()){this.fireEvent(new b(u.REDO,{edit:n}));break}}}undoableEditHappened(t){this.trim(),this.size>0&&this.size==this.history.length&&this.history.shift(),this.history.push(t),this.indexOfNextAdd=this.history.length,this.fireEvent(new b(u.ADD,{edit:t}))}trim(){if(this.history.length>this.indexOfNextAdd){const t=this.history.splice(this.indexOfNextAdd,this.history.length-this.indexOfNextAdd);for(let n=0;n<t.length;n+=1)t[n].die()}}}const re=oe;class T{constructor(t){this.first=null,this.destroyed=!1,this.dragHandler=null,this.dropHandler=null,this.x=0,this.y=0,this.width=0,this.height=0,this.defaultOpacity=20,this.enabled=!0,this.div=null,this.sharedDiv=null,this.currentX=0,this.currentY=0,this.fadeOut=!1,this.graph=t,this.graph.addMouseListener(this),this.forceRubberbandHandler=(n,i)=>{const o=i.getProperty("eventName"),r=i.getProperty("event");if(o===u.MOUSE_DOWN&&this.isForceRubberbandEvent(r)){const l=k(this.graph.container),d=D(this.graph.container);d.x-=l.x,d.y-=l.y,this.start(r.getX()+d.x,r.getY()+d.y),r.consume(!1)}},this.graph.addListener(u.FIRE_MOUSE_EVENT,this.forceRubberbandHandler),this.panHandler=()=>{this.repaint()},this.graph.addListener(u.PAN,this.panHandler),this.gestureHandler=(n,i)=>{this.first&&this.reset()},this.graph.addListener(u.GESTURE,this.gestureHandler)}isEnabled(){return this.enabled}setEnabled(t){this.enabled=t}isForceRubberbandEvent(t){return Y(t.getEvent())}mouseDown(t,n){if(!n.isConsumed()&&this.isEnabled()&&this.graph.isEnabled()&&!n.getState()&&!_(n.getEvent())){const i=k(this.graph.container),o=D(this.graph.container);o.x-=i.x,o.y-=i.y,this.start(n.getX()+o.x,n.getY()+o.y),n.consume(!1)}}start(t,n){this.first=new q(t,n);const{container:i}=this.graph;function o(r){const l=new Q(r),d=w(i,l.getX(),l.getY());return l.graphX=d.x,l.graphY=d.y,l}this.dragHandler=r=>{this.mouseMove(this.graph,o(r))},this.dropHandler=r=>{this.mouseUp(this.graph,o(r))},I.IS_FF&&u.addGestureListeners(document,null,this.dragHandler,this.dropHandler)}mouseMove(t,n){if(!n.isConsumed()&&this.first){const i=D(this.graph.container),o=k(this.graph.container);i.x-=o.x,i.y-=o.y;const r=n.getX()+i.x,l=n.getY()+i.y,d=this.first.x-r,a=this.first.y-l,h=this.graph.getEventTolerance();(this.div||Math.abs(d)>h||Math.abs(a)>h)&&(this.div||(this.div=this.createShape()),W(),this.update(r,l),n.consume())}}createShape(){this.sharedDiv||(this.sharedDiv=document.createElement("div"),this.sharedDiv.className="mxRubberband",j(this.sharedDiv,this.defaultOpacity)),this.graph.container.appendChild(this.sharedDiv);const t=this.sharedDiv;return I.IS_SVG&&this.fadeOut&&(this.sharedDiv=null),t}isActive(t,n){return this.div&&this.div.style.display!=="none"}mouseUp(t,n){const i=this.isActive();this.reset(),i&&(this.execute(n.getEvent()),n.consume())}execute(t){const n=new K(this.x,this.y,this.width,this.height);this.graph.selectRegion(n,t)}reset(){if(this.div)if(I.IS_SVG&&this.fadeOut){const t=this.div;J(t.style,"transition","all 0.2s linear"),t.style.pointerEvents="none",t.style.opacity=String(0),window.setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},200)}else this.div.parentNode&&this.div.parentNode.removeChild(this.div);u.removeGestureListeners(document,null,this.dragHandler,this.dropHandler),this.dragHandler=null,this.dropHandler=null,this.currentX=0,this.currentY=0,this.first=null,this.div=null}update(t,n){this.currentX=t,this.currentY=n,this.repaint()}repaint(){if(this.div&&this.first){const t=this.currentX-this.graph.getPanDx(),n=this.currentY-this.graph.getPanDy();this.x=Math.min(this.first.x,t),this.y=Math.min(this.first.y,n),this.width=Math.max(this.first.x,t)-this.x,this.height=Math.max(this.first.y,n)-this.y;const i=0,o=0;this.div.style.left=`${this.x+i}px`,this.div.style.top=`${this.y+o}px`,this.div.style.width=`${Math.max(1,this.width)}px`,this.div.style.height=`${Math.max(1,this.height)}px`}}onDestroy(){this.destroyed||(this.destroyed=!0,this.graph.removeMouseListener(this),this.graph.removeListener(this.forceRubberbandHandler),this.graph.removeListener(this.panHandler),this.reset(),this.sharedDiv&&(this.sharedDiv=null))}}T.pluginId="RubberBandHandler";const le=T,ae=[te,ne,se,ie,le],g=document.getElementById("graph-container");document.createElement("div");const s=new Z(g,new ee,ae),v=s.getDataModel();var x=s.getStylesheet().getDefaultEdgeStyle();x.labelBackgroundColor="#FFFFFF";x.strokeWidth=2;x.rounded=!0;x.entryPerimeter=!1;x.edgeStyle="manhattanEdgeStyle";s.options.expandedImage=null;H.selectionColor="#00a8ff";H.selectionStrokeWidth=2;const p=new re;function de(e,t){const n=(i,o)=>{const r=o.getProperty("edit");t.undoableEditHappened(r)};v.addListener(u.UNDO,n),e.getView().addListener(u.UNDO,n)}de(s,p);const ce=document.getElementById("undoButton"),he=document.getElementById("redoButton");ce.addEventListener("click",()=>{p.canUndo()&&p.undo()});he.addEventListener("click",()=>{p.canRedo()&&p.redo()});document.addEventListener("keydown",e=>{e.ctrlKey&&e.key==="z"?(e.preventDefault(),p.canUndo()&&p.undo()):e.ctrlKey&&e.key==="y"&&(e.preventDefault(),p.canRedo()&&p.redo())});const f=document.getElementById("edge-context-menu"),C=document.getElementById("edge-color-select"),L=document.getElementById("edge-thickness-select"),m=document.getElementById("text-context-menu"),X=document.getElementById("text-font-select"),P=document.getElementById("text-color-select"),G=document.getElementById("text-size-select"),A=document.getElementById("text-bold-select"),O=document.getElementById("text-italic-select"),U=document.getElementById("text-underline-select");let c=null;s.container.addEventListener("contextmenu",e=>{e.preventDefault();const t=s.getCellAt(e.offsetX,e.offsetY);if(t!=null)if(t.isEdge()){c=t;const n=g.getBoundingClientRect(),i=e.clientX-n.left,o=e.clientY-n.top;f.style.display="block",f.style.left=`${i+75}px`,f.style.top=`${o+100}px`;const r=s.getCellStyle(t);C.value=r.strokeColor||"#000000",L.value=r.strokeWidth||"1"}else if(t.isVertex()){if(t.value!=null&&t.value!=""){c=t;const n=g.getBoundingClientRect(),i=e.clientX-n.left,o=e.clientY-n.top;m.style.display="block",m.style.left=`${i+75}px`,m.style.top=`${o+100}px`;const r=s.getCellStyle(t);P.value=r.fontColor||"#000000",X.value=r.fontFamily||"Arial",G.value=r.fontSize||"12",c.style.fontStyle&1?A.classList.add("selected"):A.classList.remove("selected"),c.style.fontStyle&2?O.classList.add("selected"):O.classList.remove("selected"),c.style.fontStyle&4?U.classList.add("selected"):U.classList.remove("selected")}else if(t.style.image==null&&t.children.length==0){c=t;const n=g.getBoundingClientRect(),i=e.clientX-n.left,o=e.clientY-n.top;f.style.display="block",f.style.left=`${i+75}px`,f.style.top=`${o+100}px`;const r=s.getCellStyle(t);C.value=r.strokeColor||"#000000",L.value=r.strokeWidth||"1"}}else m.style.display="none",f.style.display="none"});const ue=document.getElementById("apply-edge-style");ue.addEventListener("click",()=>{event.preventDefault(),c&&s.batchUpdate(()=>{s.getCellStyle(c),c.isEdge()?(c.style.strokeColor=C.value,c.style.strokeWidth=parseInt(L.value,10)):(c.style.fillColor=C.value,c.style.strokeWidth=parseInt(L.value,10)),s.refresh(c)}),f.style.display="none"});const ge=document.getElementById("apply-text-style");ge.addEventListener("click",()=>{event.preventDefault(),c&&s.batchUpdate(()=>{c.style.fontFamily=X.value,c.style.fontColor=P.value,c.style.fontSize=parseInt(G.value,10);var e=0;e=e|(A.classList.contains("selected")?1:0),e=e|(O.classList.contains("selected")?2:0),e=e|(U.classList.contains("selected")?4:0),c.style.fontStyle=e,s.refresh(c)}),m.style.display="none"});const fe=document.querySelectorAll(".button");fe.forEach(e=>{e.addEventListener("click",()=>{ye(e)})});function ye(e){e.classList.toggle("selected")}document.addEventListener("click",e=>{m.contains(e.target)||(m.style.display="none"),f.contains(e.target)||(f.style.display="none")});s.setGridEnabled(!0);s.setGridSize(10);g.style.backgroundImage=`
  linear-gradient(to right, #e0e0e0 1px, transparent 1px),
  linear-gradient(to bottom, #e0e0e0 1px, transparent 1px)
`;g.style.backgroundSize="10px 10px";s.setPanning(!0);function pe(e){new F(v).import(e)}window.loadGraph=pe;async function me(e,t,n,i){try{const o=await fetch("/admin/graph/save",{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({id:e,name:t,type:n,content:i})});if(o.status!=200){const r=await o.json();throw new Error(r.message||"Erreur lors de la sauvegarde du graphe.")}}catch(o){console.error("Erreur lors de la sauvegarde :",o),alert("Erreur lors de la sauvegarde du graphe.")}}function ve(){return new F(v).export()}window.getXMLGraph=ve;function xe(){const e=new F(v).export();me(document.querySelector("#id").value,document.querySelector("#name").value,document.querySelector("#type").value,e)}const Ee=document.getElementById("saveButton");Ee.addEventListener("click",xe);const be=document.getElementById("font-btn");be.addEventListener("dragstart",e=>{e.dataTransfer.setData("node-type","text-node")});g.addEventListener("dragover",e=>{e.preventDefault()});g.addEventListener("drop",e=>{if(e.preventDefault(),e.dataTransfer.getData("node-type")=="text-node"){const t=w(s.container,R(e),N(e)),n=s.view.translate,{scale:i}=s.view,o=t.x/i-n.x,r=t.y/i-n.y;s.batchUpdate(()=>{const l=s.getDefaultParent();s.insertVertex({parent:l,value:"Text",position:[o,r],size:[150,30],style:{fillColor:"none",strokeColor:"none",fontColor:"#000000",fontSize:14,align:"left",verticalAlign:"middle"}}).setAttribute("editable","true")})}});const Se=document.getElementById("square-btn");Se.addEventListener("dragstart",e=>{e.dataTransfer.setData("node-type","square-node")});g.addEventListener("dragover",e=>{e.preventDefault()});g.addEventListener("drop",e=>{if(e.preventDefault(),e.dataTransfer.getData("node-type")=="square-node"){const t=w(s.container,R(e),N(e)),n=s.view.translate,{scale:i}=s.view,o=t.x/i-n.x,r=t.y/i-n.y;s.batchUpdate(()=>{const l=s.getDefaultParent(),d=s.insertVertex({parent:l,value:"",position:[o,r],size:[150,120],style:{fillColor:"#fffacd",strokeColor:"#000000",strokeWidth:1,rounded:2}});s.orderCells(!0,[d])})}});const M=document.getElementById("nodeImage"),B=document.getElementById("node");M.addEventListener("dragstart",e=>{e.dataTransfer.setData("node-type","icon-node")});g.addEventListener("dragover",e=>{e.preventDefault()});g.addEventListener("drop",e=>{if(e.preventDefault(),e.dataTransfer.getData("node-type")=="icon-node"&&M.src!=""){const t=w(s.container,R(e),N(e)),n=s.view.translate,{scale:i}=s.view,o=t.x/i-n.x,r=t.y/i-n.y;s.batchUpdate(()=>{const l=s.getDefaultParent(),d=v.getCell(B.value);if(d!=null)s.setSelectionCells(d);else{const a=_nodes.get(B.value),h=s.insertVertex({parent:l,id:B.value,value:a.label,position:[o-16,r-16],size:[32,32],style:{shape:"image",image:M.src,editable:!1,resizable:!0,verticalLabelPosition:"bottom",spacingTop:-15}});a.edges.forEach(function(y){const E=v.getCell(y.attachedNodeId);E!=null&&s.insertEdge({parent:l,value:"",source:h,target:E,style:{editable:!1,stroke:"#FF",strokeWidth:1,startArrow:"none",endArrow:"none"}})})}})}});const Ce=document.getElementById("zoom-in-btn"),Le=document.getElementById("zoom-out-btn");Ce.addEventListener("click",()=>{s.zoomIn()});Le.addEventListener("click",()=>{s.zoomOut()});document.addEventListener("keydown",e=>{if(e.key==="Delete"||e.key==="Backspace"){const t=s.getSelectionCells();t.length>0&&s.removeCells(t)}});$("body").keydown(function(e){e.ctrlKey&&e.keyCode==65&&(e.preventDefault(),e.stopPropagation(),s.selectAll())});s.setConnectable(!1);s.isCellDisconnectable=function(){return!1};const we=document.getElementById("group-btn"),ke=document.getElementById("ungroup-btn");we.addEventListener("click",()=>{const e=s.getSelectionCells();if(e.length>1){const t=s.getDefaultParent(),n=s.insertVertex({parent:t,style:{fillColor:"none",strokeColor:"none"}});s.addCell(n),s.groupCells(n,5,e)}});ke.addEventListener("click",()=>{const e=s.getSelectionCells();e.length==1&&(s.ungroupCells(e),s.setSelectionCells(e))});function S(e,t,n){const i=e.getSelectionCell();i&&i.isVertex()&&e.batchUpdate(()=>{const o=i.getGeometry();o&&(o.translate(t,n),e.refresh())})}document.addEventListener("keydown",e=>{switch(e.key){case"ArrowUp":S(s,0,-1);break;case"ArrowDown":S(s,0,1);break;case"ArrowLeft":S(s,-1,0);break;case"ArrowRight":S(s,1,0);break}});function De(e,t,n){const i=[],o=2*Math.PI/n;for(let r=0;r<n;r++){const l=r*o,d=e.x+t*Math.cos(l),a=e.y+t*Math.sin(l);i.push({x:d,y:a})}return i}function Ie(){let e=[];for(let t of document.getElementById("filters").options)t.selected&&e.push(t.value);return e}function Be(e,t,n){let i=!1;return s.getEdges(e).forEach(r=>{if(r.target==t&&(n==null||r.value==n)){i=!0;return}}),i||s.getEdges(t).forEach(l=>{if(l.target==e&&(n==null||l.value==n)){i=!0;return}}),i}s.addListener(u.DOUBLE_CLICK,(e,t)=>{const n=t.getProperty("cell");if(n&&n.isVertex()&&n.style.shape=="image"){const i=_nodes.get(n.id);if(i==null)return;s.batchUpdate(()=>{let o=[];const r=s.getDefaultParent(),l=Ie();i.edges.forEach(function(a){let h=_nodes.get(a.attachedNodeId);if(h!=null){const y=v.getCell(a.attachedNodeId);y==null?(l.length==0||l.includes(h.vue)||l.includes("8")&&a.edgeType==="CABLE"||l.includes("9")&&a.edgeType==="FLUX")&&o.push(a):Be(n,y,a.name)||s.insertEdge({parent:r,value:a.name,source:n,target:y,style:{editable:!1,stroke:"#FF",strokeWidth:1,startArrow:a.edgeType=="FLUX"&&(a.bidirectional||a.edgeDirection=="FROM")?"classic":"none",endArrow:a.edgeType=="FLUX"&&(a.bidirectional||a.edgeDirection=="TO")?"classic":"none"}})}}),g.getBoundingClientRect();const d=De({x:n.getGeometry().x,y:n.getGeometry().y},80,o.length);for(let a=0;a<d.length;a++){const h=o[a],y=_nodes.get(h.attachedNodeId),E=s.insertVertex({parent:r,id:y.id,value:y.label,position:[d[a].x,d[a].y],size:[32,32],style:{shape:"image",image:y.image,editable:!1,resizable:!0,verticalLabelPosition:"bottom",spacingTop:-15}});s.insertEdge({parent:r,value:o[a].name,source:n,target:E,style:{editable:!1,stroke:"#FF",strokeWidth:1,startArrow:h.edgeType=="FLUX"&&(h.bidirectional||h.edgeDirection=="FROM")?"classic":"none",endArrow:h.edgeType=="FLUX"&&(h.bidirectional||h.edgeDirection=="TO")?"classic":"none"}})}})}});const Ae=document.getElementById("update-btn");Ae.addEventListener("click",()=>{s.batchUpdate(()=>{s.getChildCells().forEach(t=>{if(!t.isEdge()){if(t.style.image!=null){const n=_nodes.get(t.id);n==null?s.removeCells([t],!0):(t.value=n.label,t.style.image=n.image)}}}),s.refresh()})});const z=s.container.querySelector("svg");function Oe(e){e.querySelectorAll("image").forEach(n=>{const i=n.getAttribute("xlink:href");fetch(i).then(o=>o.blob()).then(o=>{const r=new FileReader;r.onloadend=()=>{n.setAttribute("xlink:href",r.result)},r.readAsDataURL(o)})})}function Ue(){Oe(z),setTimeout(()=>{const t=new XMLSerializer().serializeToString(z),n=new Blob([t],{type:"image/svg+xml;charset=utf-8"}),i=URL.createObjectURL(n),o=document.createElement("a");o.href=i,o.download="graph_with_images.svg",o.click(),URL.revokeObjectURL(i)},1e3)}const Me=document.getElementById("download-btn");Me.addEventListener("click",Ue);
