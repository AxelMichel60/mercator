import{E as R,b,I as u,g as S,c as k,i as M,d as U,P as H,C as w,e as T,s as F,R as z,f as X,h as G,j as P,G as V,a as Y,k as _,S as W,l as q,m as j,M as B,V as A}from"./ModelXmlSerializer-35f2b72c.js";class K extends R{constructor(t=100){super(),this.size=100,this.history=[],this.indexOfNextAdd=0,this.size=t,this.clear()}isEmpty(){return this.history.length==0}clear(){this.history=[],this.indexOfNextAdd=0,this.fireEvent(new b(u.CLEAR))}canUndo(){return this.indexOfNextAdd>0}undo(){for(;this.indexOfNextAdd>0;){const t=this.history[--this.indexOfNextAdd];if(t.undo(),t.isSignificant()){this.fireEvent(new b(u.UNDO,{edit:t}));break}}}canRedo(){return this.indexOfNextAdd<this.history.length}redo(){const t=this.history.length;for(;this.indexOfNextAdd<t;){const n=this.history[this.indexOfNextAdd++];if(n.redo(),n.isSignificant()){this.fireEvent(new b(u.REDO,{edit:n}));break}}}undoableEditHappened(t){this.trim(),this.size>0&&this.size==this.history.length&&this.history.shift(),this.history.push(t),this.indexOfNextAdd=this.history.length,this.fireEvent(new b(u.ADD,{edit:t}))}trim(){if(this.history.length>this.indexOfNextAdd){const t=this.history.splice(this.indexOfNextAdd,this.history.length-this.indexOfNextAdd);for(let n=0;n<t.length;n+=1)t[n].die()}}}const J=K;class O{constructor(t){this.first=null,this.destroyed=!1,this.dragHandler=null,this.dropHandler=null,this.x=0,this.y=0,this.width=0,this.height=0,this.defaultOpacity=20,this.enabled=!0,this.div=null,this.sharedDiv=null,this.currentX=0,this.currentY=0,this.fadeOut=!1,this.graph=t,this.graph.addMouseListener(this),this.forceRubberbandHandler=(n,r)=>{const i=r.getProperty("eventName"),o=r.getProperty("event");if(i===u.MOUSE_DOWN&&this.isForceRubberbandEvent(o)){const a=S(this.graph.container),d=k(this.graph.container);d.x-=a.x,d.y-=a.y,this.start(o.getX()+d.x,o.getY()+d.y),o.consume(!1)}},this.graph.addListener(u.FIRE_MOUSE_EVENT,this.forceRubberbandHandler),this.panHandler=()=>{this.repaint()},this.graph.addListener(u.PAN,this.panHandler),this.gestureHandler=(n,r)=>{this.first&&this.reset()},this.graph.addListener(u.GESTURE,this.gestureHandler)}isEnabled(){return this.enabled}setEnabled(t){this.enabled=t}isForceRubberbandEvent(t){return M(t.getEvent())}mouseDown(t,n){if(!n.isConsumed()&&this.isEnabled()&&this.graph.isEnabled()&&!n.getState()&&!U(n.getEvent())){const r=S(this.graph.container),i=k(this.graph.container);i.x-=r.x,i.y-=r.y,this.start(n.getX()+i.x,n.getY()+i.y),n.consume(!1)}}start(t,n){this.first=new H(t,n);const{container:r}=this.graph;function i(o){const a=new G(o),d=P(r,a.getX(),a.getY());return a.graphX=d.x,a.graphY=d.y,a}this.dragHandler=o=>{this.mouseMove(this.graph,i(o))},this.dropHandler=o=>{this.mouseUp(this.graph,i(o))},w.IS_FF&&u.addGestureListeners(document,null,this.dragHandler,this.dropHandler)}mouseMove(t,n){if(!n.isConsumed()&&this.first){const r=k(this.graph.container),i=S(this.graph.container);r.x-=i.x,r.y-=i.y;const o=n.getX()+r.x,a=n.getY()+r.y,d=this.first.x-o,l=this.first.y-a,c=this.graph.getEventTolerance();(this.div||Math.abs(d)>c||Math.abs(l)>c)&&(this.div||(this.div=this.createShape()),T(),this.update(o,a),n.consume())}}createShape(){this.sharedDiv||(this.sharedDiv=document.createElement("div"),this.sharedDiv.className="mxRubberband",F(this.sharedDiv,this.defaultOpacity)),this.graph.container.appendChild(this.sharedDiv);const t=this.sharedDiv;return w.IS_SVG&&this.fadeOut&&(this.sharedDiv=null),t}isActive(t,n){return this.div&&this.div.style.display!=="none"}mouseUp(t,n){const r=this.isActive();this.reset(),r&&(this.execute(n.getEvent()),n.consume())}execute(t){const n=new z(this.x,this.y,this.width,this.height);this.graph.selectRegion(n,t)}reset(){if(this.div)if(w.IS_SVG&&this.fadeOut){const t=this.div;X(t.style,"transition","all 0.2s linear"),t.style.pointerEvents="none",t.style.opacity=String(0),window.setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},200)}else this.div.parentNode&&this.div.parentNode.removeChild(this.div);u.removeGestureListeners(document,null,this.dragHandler,this.dropHandler),this.dragHandler=null,this.dropHandler=null,this.currentX=0,this.currentY=0,this.first=null,this.div=null}update(t,n){this.currentX=t,this.currentY=n,this.repaint()}repaint(){if(this.div&&this.first){const t=this.currentX-this.graph.getPanDx(),n=this.currentY-this.graph.getPanDy();this.x=Math.min(this.first.x,t),this.y=Math.min(this.first.y,n),this.width=Math.max(this.first.x,t)-this.x,this.height=Math.max(this.first.y,n)-this.y;const r=0,i=0;this.div.style.left=`${this.x+r}px`,this.div.style.top=`${this.y+i}px`,this.div.style.width=`${Math.max(1,this.width)}px`,this.div.style.height=`${Math.max(1,this.height)}px`}}onDestroy(){this.destroyed||(this.destroyed=!0,this.graph.removeMouseListener(this),this.graph.removeListener(this.forceRubberbandHandler),this.graph.removeListener(this.panHandler),this.reset(),this.sharedDiv&&(this.sharedDiv=null))}}O.pluginId="RubberBandHandler";const Q=O,Z=[_,W,q,j,Q],h=document.getElementById("graph-container");document.createElement("div");const s=new V(h,new Y,Z),m=s.getDataModel();var E=s.getStylesheet().getDefaultEdgeStyle();E.labelBackgroundColor="#FFFFFF";E.strokeWidth=2;E.rounded=!0;E.entryPerimeter=!1;E.edgeStyle="manhattanEdgeStyle";A.selectionColor="#00a8ff";A.selectionStrokeWidth=2;const f=new J;function ee(e,t){const n=(r,i)=>{const o=i.getProperty("edit");t.undoableEditHappened(o)};m.addListener(u.UNDO,n),e.getView().addListener(u.UNDO,n)}ee(s,f);const te=document.getElementById("undoButton"),ne=document.getElementById("redoButton");te.addEventListener("click",()=>{f.canUndo()&&f.undo()});ne.addEventListener("click",()=>{f.canRedo()&&f.redo()});document.addEventListener("keydown",e=>{e.ctrlKey&&e.key==="z"?(e.preventDefault(),f.canUndo()&&f.undo()):(e.ctrlKey&&e.key==="y"||e.ctrlKey&&e.shiftKey&&e.key==="z")&&(e.preventDefault(),f.canRedo()&&f.redo())});const g=document.getElementById("context-menu"),v=document.getElementById("edge-color-select"),x=document.getElementById("edge-thickness-select"),se=document.getElementById("apply-edge-style");let p=null;s.container.addEventListener("contextmenu",e=>{e.preventDefault();const t=s.getCellAt(e.offsetX,e.offsetY);if(t!=null)if(t.isEdge()){p=t;const n=h.getBoundingClientRect(),r=e.clientX-n.left,i=e.clientY-n.top;g.style.display="block",g.style.left=`${r+75}px`,g.style.top=`${i+100}px`;const o=s.getCellStyle(t);v.value=o.strokeColor||"#000000",x.value=o.strokeWidth||"1"}else if(t.isVertex()){if(t.style.image==null){p=t;const n=h.getBoundingClientRect(),r=e.clientX-n.left,i=e.clientY-n.top;g.style.display="block",g.style.left=`${r+75}px`,g.style.top=`${i+100}px`;const o=s.getCellStyle(t);v.value=o.strokeColor||"#000000",x.value=o.strokeWidth||"1"}}else g.style.display="none"});se.addEventListener("click",()=>{console.log("change style"),event.preventDefault(),p&&(console.log(p),console.log("update edge "+v.value+" "+x.value),s.batchUpdate(()=>{const e=s.getCellStyle(p);console.log(e),p.isEdge()?s.setCellStyle({...e,strokeColor:v.value,strokeWidth:parseInt(x.value,10)},[p]):s.setCellStyle({...e,fillColor:v.value,strokeWidth:parseInt(x.value,10)},[p])})),g.style.display="none"});document.addEventListener("click",e=>{g.contains(e.target)||(g.style.display="none")});s.setGridEnabled(!0);s.setGridSize(10);h.style.backgroundImage=`
  linear-gradient(to right, #e0e0e0 1px, transparent 1px),
  linear-gradient(to bottom, #e0e0e0 1px, transparent 1px)
`;h.style.backgroundSize="10px 10px";s.setPanning(!0);function ie(e){new B(m).import(e)}window.loadGraph=ie;async function re(e,t,n,r){try{const i=await fetch("/admin/graph/save",{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({id:e,name:t,type:n,content:r})});if(!i.ok){const a=await i.json();throw new Error(a.message||"Erreur lors de la sauvegarde du graphe.")}const o=await i.json();console.log("Graphe sauvegardé avec succès :",o.graph)}catch(i){console.error("Erreur lors de la sauvegarde :",i),alert("Erreur lors de la sauvegarde du graphe.")}}function oe(){return new B(m).export()}window.getXMLGraph=oe;function ae(){const e=new B(m).export();re(document.querySelector("#id").value,document.querySelector("#name").value,document.querySelector("#type").value,e)}const le=document.getElementById("saveButton");le.addEventListener("click",ae);const de=document.getElementById("font-btn");de.addEventListener("dragstart",e=>{e.dataTransfer.setData("node-type","text-node")});h.addEventListener("dragover",e=>{e.preventDefault()});h.addEventListener("drop",e=>{if(e.preventDefault(),e.dataTransfer.getData("node-type")=="text-node"){const t=h.getBoundingClientRect(),n=e.clientX-t.left,r=e.clientY-t.top;s.batchUpdate(()=>{const i=s.getDefaultParent();s.insertVertex({parent:i,value:"Text",position:[n,r],size:[150,30],style:{fillColor:"none",strokeColor:"none",fontColor:"#000000",fontSize:14,align:"left",verticalAlign:"middle"}}).setAttribute("editable","true")})}});const ce=document.getElementById("square-btn");ce.addEventListener("dragstart",e=>{e.dataTransfer.setData("node-type","square-node")});h.addEventListener("dragover",e=>{e.preventDefault()});h.addEventListener("drop",e=>{if(e.preventDefault(),e.dataTransfer.getData("node-type")=="square-node"){const t=h.getBoundingClientRect(),n=e.clientX-t.left,r=e.clientY-t.top;s.batchUpdate(()=>{const i=s.getDefaultParent(),o=s.insertVertex({parent:i,value:"",position:[n,r],size:[150,120],style:{fillColor:"#fffacd",strokeColor:"#000000",strokeWidth:1,rounded:2}});s.orderCells(!0,[o])})}});const L=document.getElementById("nodeImage"),D=document.getElementById("node");L.addEventListener("dragstart",e=>{e.dataTransfer.setData("node-type","icon-node")});h.addEventListener("dragover",e=>{e.preventDefault()});h.addEventListener("drop",e=>{if(e.preventDefault(),e.dataTransfer.getData("node-type")=="icon-node"&&L.src!=""){const t=h.getBoundingClientRect(),n=e.clientX-t.left,r=e.clientY-t.top;s.batchUpdate(()=>{const i=s.getDefaultParent(),o=m.getCell(D.value);if(o!=null)s.setSelectionCells(o);else{const a=_nodes.get(D.value),d=s.insertVertex({parent:i,id:D.value,value:a.label,position:[n-16,r-16],size:[32,32],style:{shape:"image",image:L.src,editable:!1,resizable:!1,verticalLabelPosition:"bottom",spacingTop:-15}});a.edges.forEach(function(l){const c=m.getCell(l.attachedNodeId);c!=null&&s.insertEdge({parent:i,value:"",source:d,target:c,style:{editable:!1,stroke:"#FF",strokeWidth:1,startArrow:"none",endArrow:"none"}})})}})}});const he=document.getElementById("zoom-in-btn"),ue=document.getElementById("zoom-out-btn");he.addEventListener("click",()=>{s.zoom(1.2)});ue.addEventListener("click",()=>{s.zoom(.8)});document.addEventListener("keydown",e=>{if(e.key==="Delete"){const t=s.getSelectionCells();t.length>0&&s.removeCells(t)}});$("body").keydown(function(e){e.ctrlKey&&e.keyCode==65&&(e.preventDefault(),e.stopPropagation(),s.selectAll())});s.setConnectable(!1);s.isCellDisconnectable=function(){return!1};const ge=document.getElementById("group-btn"),fe=document.getElementById("ungroup-btn");ge.addEventListener("click",()=>{const e=s.getSelectionCells();if(e.length>0){const t=s.createVertex(null,null,"",0,0,100,100,"mxGroup");s.addCell(t),s.groupCells(t,0,e)}});fe.addEventListener("click",()=>{const e=s.getSelectionCells();e.length>0&&(s.ungroupCells(e),s.setSelectionCells(e))});function C(e,t,n){const r=e.getSelectionCell();r&&r.isVertex()&&e.batchUpdate(()=>{const i=r.getGeometry();i&&(i.translate(t,n),e.refresh())})}document.addEventListener("keydown",e=>{switch(e.key){case"ArrowUp":C(s,0,-1);break;case"ArrowDown":C(s,0,1);break;case"ArrowLeft":C(s,-1,0);break;case"ArrowRight":C(s,1,0);break}});function pe(e,t,n){const r=[],i=2*Math.PI/n;for(let o=0;o<n;o++){const a=o*i,d=e.x+t*Math.cos(a),l=e.y+t*Math.sin(a);r.push({x:d,y:l})}return r}function ye(){let e=[];for(let t of document.getElementById("filters").options)t.selected&&e.push(t.value);return e}function me(e,t,n){let r=!1;return s.getEdges(e).forEach(o=>{if(o.target==t&&(n==null||o.value==n)){r=!0;return}}),r||s.getEdges(t).forEach(a=>{if(a.target==e&&(n==null||a.value==n)){r=!0;return}}),r}s.addListener(u.DOUBLE_CLICK,(e,t)=>{const n=t.getProperty("cell");if(n&&n.isVertex()&&n.style.shape=="image"){const r=_nodes.get(n.id);if(r==null)return;s.batchUpdate(()=>{let i=[];const o=s.getDefaultParent(),a=ye();console.log("filter= "+a+" filter.includes(8) "+a.includes("8")),r.edges.forEach(function(l){let c=_nodes.get(l.attachedNodeId);if(c!=null){const y=m.getCell(l.attachedNodeId);y==null?(a.length==0||a.includes(c.vue)||a.includes("8")&&l.edgeType==="CABLE"||a.includes("9")&&l.edgeType==="FLUX")&&i.push(l):me(n,y,l.name)||s.insertEdge({parent:o,value:l.name,source:n,target:y,style:{editable:!1,stroke:"#FF",strokeWidth:1,startArrow:l.edgeType=="FLUX"&&(l.bidirectional||l.edgeDirection=="FROM")?"classic":"none",endArrow:l.edgeType=="FLUX"&&(l.bidirectional||l.edgeDirection=="TO")?"classic":"none"}})}}),h.getBoundingClientRect();const d=pe({x:n.getGeometry().x,y:n.getGeometry().y},80,i.length);for(let l=0;l<d.length;l++){const c=i[l],y=_nodes.get(c.attachedNodeId),N=s.insertVertex({parent:o,id:y.id,value:y.label,position:[d[l].x,d[l].y],size:[32,32],style:{shape:"image",image:y.image,editable:!1,resizable:!1,verticalLabelPosition:"bottom",spacingTop:-15}});s.insertEdge({parent:o,value:i[l].name,source:n,target:N,style:{editable:!1,stroke:"#FF",strokeWidth:1,startArrow:c.edgeType=="FLUX"&&(c.bidirectional||c.edgeDirection=="FROM")?"classic":"none",endArrow:c.edgeType=="FLUX"&&(c.bidirectional||c.edgeDirection=="TO")?"classic":"none"}})}})}});const ve=document.getElementById("update-btn");ve.addEventListener("click",()=>{s.batchUpdate(()=>{s.getChildCells().forEach(t=>{if(!t.isEdge()){if(t.style.image!=null){const n=_nodes.get(t.id);n==null?s.removeCells([t],!0):(t.value=n.label,t.style.image=n.image)}}}),s.refresh()})});const I=s.container.querySelector("svg");function xe(e){e.querySelectorAll("image").forEach(n=>{const r=n.getAttribute("xlink:href");fetch(r).then(i=>i.blob()).then(i=>{const o=new FileReader;o.onloadend=()=>{n.setAttribute("xlink:href",o.result)},o.readAsDataURL(i)})})}function Ee(){xe(I),setTimeout(()=>{const t=new XMLSerializer().serializeToString(I),n=new Blob([t],{type:"image/svg+xml;charset=utf-8"}),r=URL.createObjectURL(n),i=document.createElement("a");i.href=r,i.download="graph_with_images.svg",i.click(),URL.revokeObjectURL(r)},1e3)}const be=document.getElementById("download-btn");be.addEventListener("click",Ee);
