import{E as R,b as x,I as u,g as k,c as w,i as M,d as U,P as H,C as S,e as T,s as F,R as z,f as X,h as P,j as G,G as V,a as Y,k as _,S as W,l as q,m as j,M as B,V as O}from"./ModelXmlSerializer-35f2b72c.js";class K extends R{constructor(e=100){super(),this.size=100,this.history=[],this.indexOfNextAdd=0,this.size=e,this.clear()}isEmpty(){return this.history.length==0}clear(){this.history=[],this.indexOfNextAdd=0,this.fireEvent(new x(u.CLEAR))}canUndo(){return this.indexOfNextAdd>0}undo(){for(;this.indexOfNextAdd>0;){const e=this.history[--this.indexOfNextAdd];if(e.undo(),e.isSignificant()){this.fireEvent(new x(u.UNDO,{edit:e}));break}}}canRedo(){return this.indexOfNextAdd<this.history.length}redo(){const e=this.history.length;for(;this.indexOfNextAdd<e;){const n=this.history[this.indexOfNextAdd++];if(n.redo(),n.isSignificant()){this.fireEvent(new x(u.REDO,{edit:n}));break}}}undoableEditHappened(e){this.trim(),this.size>0&&this.size==this.history.length&&this.history.shift(),this.history.push(e),this.indexOfNextAdd=this.history.length,this.fireEvent(new x(u.ADD,{edit:e}))}trim(){if(this.history.length>this.indexOfNextAdd){const e=this.history.splice(this.indexOfNextAdd,this.history.length-this.indexOfNextAdd);for(let n=0;n<e.length;n+=1)e[n].die()}}}const J=K;class A{constructor(e){this.first=null,this.destroyed=!1,this.dragHandler=null,this.dropHandler=null,this.x=0,this.y=0,this.width=0,this.height=0,this.defaultOpacity=20,this.enabled=!0,this.div=null,this.sharedDiv=null,this.currentX=0,this.currentY=0,this.fadeOut=!1,this.graph=e,this.graph.addMouseListener(this),this.forceRubberbandHandler=(n,r)=>{const i=r.getProperty("eventName"),o=r.getProperty("event");if(i===u.MOUSE_DOWN&&this.isForceRubberbandEvent(o)){const l=k(this.graph.container),d=w(this.graph.container);d.x-=l.x,d.y-=l.y,this.start(o.getX()+d.x,o.getY()+d.y),o.consume(!1)}},this.graph.addListener(u.FIRE_MOUSE_EVENT,this.forceRubberbandHandler),this.panHandler=()=>{this.repaint()},this.graph.addListener(u.PAN,this.panHandler),this.gestureHandler=(n,r)=>{this.first&&this.reset()},this.graph.addListener(u.GESTURE,this.gestureHandler)}isEnabled(){return this.enabled}setEnabled(e){this.enabled=e}isForceRubberbandEvent(e){return M(e.getEvent())}mouseDown(e,n){if(!n.isConsumed()&&this.isEnabled()&&this.graph.isEnabled()&&!n.getState()&&!U(n.getEvent())){const r=k(this.graph.container),i=w(this.graph.container);i.x-=r.x,i.y-=r.y,this.start(n.getX()+i.x,n.getY()+i.y),n.consume(!1)}}start(e,n){this.first=new H(e,n);const{container:r}=this.graph;function i(o){const l=new P(o),d=G(r,l.getX(),l.getY());return l.graphX=d.x,l.graphY=d.y,l}this.dragHandler=o=>{this.mouseMove(this.graph,i(o))},this.dropHandler=o=>{this.mouseUp(this.graph,i(o))},S.IS_FF&&u.addGestureListeners(document,null,this.dragHandler,this.dropHandler)}mouseMove(e,n){if(!n.isConsumed()&&this.first){const r=w(this.graph.container),i=k(this.graph.container);r.x-=i.x,r.y-=i.y;const o=n.getX()+r.x,l=n.getY()+r.y,d=this.first.x-o,a=this.first.y-l,c=this.graph.getEventTolerance();(this.div||Math.abs(d)>c||Math.abs(a)>c)&&(this.div||(this.div=this.createShape()),T(),this.update(o,l),n.consume())}}createShape(){this.sharedDiv||(this.sharedDiv=document.createElement("div"),this.sharedDiv.className="mxRubberband",F(this.sharedDiv,this.defaultOpacity)),this.graph.container.appendChild(this.sharedDiv);const e=this.sharedDiv;return S.IS_SVG&&this.fadeOut&&(this.sharedDiv=null),e}isActive(e,n){return this.div&&this.div.style.display!=="none"}mouseUp(e,n){const r=this.isActive();this.reset(),r&&(this.execute(n.getEvent()),n.consume())}execute(e){const n=new z(this.x,this.y,this.width,this.height);this.graph.selectRegion(n,e)}reset(){if(this.div)if(S.IS_SVG&&this.fadeOut){const e=this.div;X(e.style,"transition","all 0.2s linear"),e.style.pointerEvents="none",e.style.opacity=String(0),window.setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},200)}else this.div.parentNode&&this.div.parentNode.removeChild(this.div);u.removeGestureListeners(document,null,this.dragHandler,this.dropHandler),this.dragHandler=null,this.dropHandler=null,this.currentX=0,this.currentY=0,this.first=null,this.div=null}update(e,n){this.currentX=e,this.currentY=n,this.repaint()}repaint(){if(this.div&&this.first){const e=this.currentX-this.graph.getPanDx(),n=this.currentY-this.graph.getPanDy();this.x=Math.min(this.first.x,e),this.y=Math.min(this.first.y,n),this.width=Math.max(this.first.x,e)-this.x,this.height=Math.max(this.first.y,n)-this.y;const r=0,i=0;this.div.style.left=`${this.x+r}px`,this.div.style.top=`${this.y+i}px`,this.div.style.width=`${Math.max(1,this.width)}px`,this.div.style.height=`${Math.max(1,this.height)}px`}}onDestroy(){this.destroyed||(this.destroyed=!0,this.graph.removeMouseListener(this),this.graph.removeListener(this.forceRubberbandHandler),this.graph.removeListener(this.panHandler),this.reset(),this.sharedDiv&&(this.sharedDiv=null))}}A.pluginId="RubberBandHandler";const Q=A,Z=[_,W,q,j,Q],h=document.getElementById("graph-container");document.createElement("div");const s=new V(h,new Y,Z),m=s.getDataModel();var v=s.getStylesheet().getDefaultEdgeStyle();v.labelBackgroundColor="#FFFFFF";v.strokeWidth=2;v.rounded=!0;v.entryPerimeter=!1;v.edgeStyle="manhattanEdgeStyle";s.options.expandedImage=null;O.selectionColor="#00a8ff";O.selectionStrokeWidth=2;const p=new J;function ee(t,e){const n=(r,i)=>{const o=i.getProperty("edit");e.undoableEditHappened(o)};m.addListener(u.UNDO,n),t.getView().addListener(u.UNDO,n)}ee(s,p);const te=document.getElementById("undoButton"),ne=document.getElementById("redoButton");te.addEventListener("click",()=>{p.canUndo()&&p.undo()});ne.addEventListener("click",()=>{p.canRedo()&&p.redo()});document.addEventListener("keydown",t=>{t.ctrlKey&&t.key==="z"?(t.preventDefault(),p.canUndo()&&p.undo()):(t.ctrlKey&&t.key==="y"||t.ctrlKey&&t.shiftKey&&t.key==="z")&&(t.preventDefault(),p.canRedo()&&p.redo())});const f=document.getElementById("context-menu"),b=document.getElementById("edge-color-select"),C=document.getElementById("edge-thickness-select"),se=document.getElementById("apply-edge-style");let g=null;s.container.addEventListener("contextmenu",t=>{t.preventDefault();const e=s.getCellAt(t.offsetX,t.offsetY);if(e!=null)if(e.isEdge()){g=e;const n=h.getBoundingClientRect(),r=t.clientX-n.left,i=t.clientY-n.top;f.style.display="block",f.style.left=`${r+75}px`,f.style.top=`${i+100}px`;const o=s.getCellStyle(e);b.value=o.strokeColor||"#000000",C.value=o.strokeWidth||"1"}else if(e.isVertex()){if(e.style.image==null){g=e;const n=h.getBoundingClientRect(),r=t.clientX-n.left,i=t.clientY-n.top;f.style.display="block",f.style.left=`${r+75}px`,f.style.top=`${i+100}px`;const o=s.getCellStyle(e);b.value=o.strokeColor||"#000000",C.value=o.strokeWidth||"1"}}else f.style.display="none"});se.addEventListener("click",()=>{event.preventDefault(),g&&s.batchUpdate(()=>{s.getCellStyle(g),g.isEdge()?(g.style.strokeColor=b.value,g.style.strokeWidth=parseInt(C.value,10)):(g.style.fillColor=b.value,g.style.strokeWidth=parseInt(C.value,10)),s.refresh(g)}),f.style.display="none"});document.addEventListener("click",t=>{f.contains(t.target)||(f.style.display="none")});s.setGridEnabled(!0);s.setGridSize(10);h.style.backgroundImage=`
  linear-gradient(to right, #e0e0e0 1px, transparent 1px),
  linear-gradient(to bottom, #e0e0e0 1px, transparent 1px)
`;h.style.backgroundSize="10px 10px";s.setPanning(!0);function ie(t){new B(m).import(t)}window.loadGraph=ie;async function re(t,e,n,r){try{const i=await fetch("/admin/graph/save",{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({id:t,name:e,type:n,content:r})});if(i.status!=200){const o=await i.json();throw new Error(o.message||"Erreur lors de la sauvegarde du graphe.")}}catch(i){console.error("Erreur lors de la sauvegarde :",i),alert("Erreur lors de la sauvegarde du graphe.")}}function oe(){return new B(m).export()}window.getXMLGraph=oe;function ae(){const t=new B(m).export();re(document.querySelector("#id").value,document.querySelector("#name").value,document.querySelector("#type").value,t)}const le=document.getElementById("saveButton");le.addEventListener("click",ae);const de=document.getElementById("font-btn");de.addEventListener("dragstart",t=>{t.dataTransfer.setData("node-type","text-node")});h.addEventListener("dragover",t=>{t.preventDefault()});h.addEventListener("drop",t=>{if(t.preventDefault(),t.dataTransfer.getData("node-type")=="text-node"){const e=h.getBoundingClientRect(),n=t.clientX-e.left,r=t.clientY-e.top;s.batchUpdate(()=>{const i=s.getDefaultParent();s.insertVertex({parent:i,value:"Text",position:[n,r],size:[150,30],style:{fillColor:"none",strokeColor:"none",fontColor:"#000000",fontSize:14,align:"left",verticalAlign:"middle"}}).setAttribute("editable","true")})}});const ce=document.getElementById("square-btn");ce.addEventListener("dragstart",t=>{t.dataTransfer.setData("node-type","square-node")});h.addEventListener("dragover",t=>{t.preventDefault()});h.addEventListener("drop",t=>{if(t.preventDefault(),t.dataTransfer.getData("node-type")=="square-node"){const e=h.getBoundingClientRect(),n=t.clientX-e.left,r=t.clientY-e.top;s.batchUpdate(()=>{const i=s.getDefaultParent(),o=s.insertVertex({parent:i,value:"",position:[n,r],size:[150,120],style:{fillColor:"#fffacd",strokeColor:"#000000",strokeWidth:1,rounded:2}});s.orderCells(!0,[o])})}});const L=document.getElementById("nodeImage"),D=document.getElementById("node");L.addEventListener("dragstart",t=>{t.dataTransfer.setData("node-type","icon-node")});h.addEventListener("dragover",t=>{t.preventDefault()});h.addEventListener("drop",t=>{if(t.preventDefault(),t.dataTransfer.getData("node-type")=="icon-node"&&L.src!=""){const e=h.getBoundingClientRect(),n=t.clientX-e.left,r=t.clientY-e.top;s.batchUpdate(()=>{const i=s.getDefaultParent(),o=m.getCell(D.value);if(o!=null)s.setSelectionCells(o);else{const l=_nodes.get(D.value),d=s.insertVertex({parent:i,id:D.value,value:l.label,position:[n-16,r-16],size:[32,32],style:{shape:"image",image:L.src,editable:!1,resizable:!1,verticalLabelPosition:"bottom",spacingTop:-15}});l.edges.forEach(function(a){const c=m.getCell(a.attachedNodeId);c!=null&&s.insertEdge({parent:i,value:"",source:d,target:c,style:{editable:!1,stroke:"#FF",strokeWidth:1,startArrow:"none",endArrow:"none"}})})}})}});const he=document.getElementById("zoom-in-btn"),ue=document.getElementById("zoom-out-btn");he.addEventListener("click",()=>{s.zoomIn()});ue.addEventListener("click",()=>{s.zoomOut()});document.addEventListener("keydown",t=>{if(t.key==="Delete"){const e=s.getSelectionCells();e.length>0&&s.removeCells(e)}});$("body").keydown(function(t){t.ctrlKey&&t.keyCode==65&&(t.preventDefault(),t.stopPropagation(),s.selectAll())});s.setConnectable(!1);s.isCellDisconnectable=function(){return!1};const ge=document.getElementById("group-btn"),fe=document.getElementById("ungroup-btn");ge.addEventListener("click",()=>{const t=s.getSelectionCells();if(t.length>1){const e=s.getDefaultParent(),n=s.insertVertex({parent:e,style:{fillColor:"none",strokeColor:"none"}});s.addCell(n),s.groupCells(n,5,t)}});fe.addEventListener("click",()=>{const t=s.getSelectionCells();t.length==1&&(s.ungroupCells(t),s.setSelectionCells(t))});function E(t,e,n){const r=t.getSelectionCell();r&&r.isVertex()&&t.batchUpdate(()=>{const i=r.getGeometry();i&&(i.translate(e,n),t.refresh())})}document.addEventListener("keydown",t=>{switch(t.key){case"ArrowUp":E(s,0,-1);break;case"ArrowDown":E(s,0,1);break;case"ArrowLeft":E(s,-1,0);break;case"ArrowRight":E(s,1,0);break}});function pe(t,e,n){const r=[],i=2*Math.PI/n;for(let o=0;o<n;o++){const l=o*i,d=t.x+e*Math.cos(l),a=t.y+e*Math.sin(l);r.push({x:d,y:a})}return r}function ye(){let t=[];for(let e of document.getElementById("filters").options)e.selected&&t.push(e.value);return t}function me(t,e,n){let r=!1;return s.getEdges(t).forEach(o=>{if(o.target==e&&(n==null||o.value==n)){r=!0;return}}),r||s.getEdges(e).forEach(l=>{if(l.target==t&&(n==null||l.value==n)){r=!0;return}}),r}s.addListener(u.DOUBLE_CLICK,(t,e)=>{const n=e.getProperty("cell");if(n&&n.isVertex()&&n.style.shape=="image"){const r=_nodes.get(n.id);if(r==null)return;s.batchUpdate(()=>{let i=[];const o=s.getDefaultParent(),l=ye();r.edges.forEach(function(a){let c=_nodes.get(a.attachedNodeId);if(c!=null){const y=m.getCell(a.attachedNodeId);y==null?(l.length==0||l.includes(c.vue)||l.includes("8")&&a.edgeType==="CABLE"||l.includes("9")&&a.edgeType==="FLUX")&&i.push(a):me(n,y,a.name)||s.insertEdge({parent:o,value:a.name,source:n,target:y,style:{editable:!1,stroke:"#FF",strokeWidth:1,startArrow:a.edgeType=="FLUX"&&(a.bidirectional||a.edgeDirection=="FROM")?"classic":"none",endArrow:a.edgeType=="FLUX"&&(a.bidirectional||a.edgeDirection=="TO")?"classic":"none"}})}}),h.getBoundingClientRect();const d=pe({x:n.getGeometry().x,y:n.getGeometry().y},80,i.length);for(let a=0;a<d.length;a++){const c=i[a],y=_nodes.get(c.attachedNodeId),N=s.insertVertex({parent:o,id:y.id,value:y.label,position:[d[a].x,d[a].y],size:[32,32],style:{shape:"image",image:y.image,editable:!1,resizable:!1,verticalLabelPosition:"bottom",spacingTop:-15}});s.insertEdge({parent:o,value:i[a].name,source:n,target:N,style:{editable:!1,stroke:"#FF",strokeWidth:1,startArrow:c.edgeType=="FLUX"&&(c.bidirectional||c.edgeDirection=="FROM")?"classic":"none",endArrow:c.edgeType=="FLUX"&&(c.bidirectional||c.edgeDirection=="TO")?"classic":"none"}})}})}});const ve=document.getElementById("update-btn");ve.addEventListener("click",()=>{s.batchUpdate(()=>{s.getChildCells().forEach(e=>{if(!e.isEdge()){if(e.style.image!=null){const n=_nodes.get(e.id);n==null?s.removeCells([e],!0):(e.value=n.label,e.style.image=n.image)}}}),s.refresh()})});const I=s.container.querySelector("svg");function xe(t){t.querySelectorAll("image").forEach(n=>{const r=n.getAttribute("xlink:href");fetch(r).then(i=>i.blob()).then(i=>{const o=new FileReader;o.onloadend=()=>{n.setAttribute("xlink:href",o.result)},o.readAsDataURL(i)})})}function Ee(){xe(I),setTimeout(()=>{const e=new XMLSerializer().serializeToString(I),n=new Blob([e],{type:"image/svg+xml;charset=utf-8"}),r=URL.createObjectURL(n),i=document.createElement("a");i.href=r,i.download="graph_with_images.svg",i.click(),URL.revokeObjectURL(r)},1e3)}const be=document.getElementById("download-btn");be.addEventListener("click",Ee);
